# Импортер ученических билетов в СКУД "RusGuard"

## Описание

Если вы работаете в школе (гимназии) Минска, то вы могли уже получить пачку "ученических билетов", которые нужно
добавить в СКУД RusGuard для того, чтобы ученики могли проходить через школу. Но добавить их вручную - это долго и скучно (нам
приехало 1310 карточек). Поэтому я написал этот скрипт, который автоматизирует этот процесс.

## Предостережения

1. Программа не является официальной, и не поддерживается разработчиками СКУД. Используйте на свой страх и риск.
2. Программа сопоставляет данные учащихся из заявки и СКУД на основе **полного соответствия ФИО**. Если у вас в БД СКУД
   много учащихся с неполным ФИО, программа не сможет их добавить. Возможно, следует проверить кол-во учащихся в БД СКУД
   с полным ФИО и если их слишком мало, возможно, придётся добавить их вручную.

## Подготовка

Для запуска скрипта необходимо установить Java 8 и добавить его в PATH. Для поиска инструкции воспользуйтесь любым
поисковиком.

### Подготовка файла с данными карточек

Для работы скрипта необходимо скачать и подготовить файлы ученических билетов.
Для этого воспользуйтесь программой "БИБ-Электрон", которая была отправлена Вашему УО (с помощью этой программы также
отправлялись заявки на карточки, так что она уже должна быть где-то в школе).

Далее в этой программе нужно открыть заявки и нажать "Экспорт". В открывшемся окне сохраните файл в любое удобное место.

Откройте этот файл в Excel и удалите **все** колонки кроме "Фамилия", "Имя", "Отчество", "Параллель", "Буква класса" и "
ID чипа карты в результате выполнения заявки". Выделите колонку (и все ячейки в этой колонке) с ID чипа карты и
выберите "Формат" -> "Текст". Используя функцию "Поиск и замена" замените шаблоны "????????," (без кавычек) на пустую
строку.
Удалите оглавления колонок (если они есть) и сохраните файл в формате CSV (разделитель - запятая) в папку с программой
под названием "applications.csv".

### Подготовка файлов RusGuard

Самое сложное.

Для этого вам понадобится программа Fiddler Classic (или любой другой HTTP-прокси, который умеет сохранять запросы;
инструкция заточена под Fiddler). Скачать её можно [здесь](https://www.telerik.com/download/fiddler). Настройте перехват
HTTPS-запросов (инструкцию найдёте в интернете).

#### Получение данных для входа в RusGuard

Запустите Fiddler и откройте Автоматизированное рабочее
место RusGuard.
Войдите в рабочее место, **быстро** вернитесь в Fiddler и нажмите кнопку "F12" на клавиатуре (остановит перехват
запросов, что значительно упростит поиск нужных запросов).
Найдите любой запрос, где в ответе есть раздел "UsernameToken". Скопируйте этот раздел (пример представлен ниже) и
вставьте его в файл "request-template.xml" в соответствующее поле.

```xml
<!--Пример того, что нужно скопировать (важно: этот пример нельзя вставлять в шаблон так как тут используется пустой UUID)-->
<o:UsernameToken u:Id="uuid-00000000-0000-0000-0000-000000000000-0000">
    <o:Username>администратор</o:Username>
    <o:Password Type="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText">
        12345678
    </o:Password>
</o:UsernameToken>
```

#### Получение списка учеников

Опять нажмите "F12" и в рабочем месте RusGuard откройте список **всех** сотрудников (вкладка "Сотрудники" -> "Все").
Справа сверху выберите отображение 3000 сотрудников на странице (это нужно для того, чтобы в дальнейшем не пришлось
перехватывать запросы на каждую страницу).
Быстро перейдите в Fiddler и нажмите F12.
Найдите запрос, где в ответе есть фамилии учеников (обычно он очень длинный и весит +-3 МБ). Скопируйте всё тело ответа
и сохраните его
в файл "user-list.xml" (создайте этот файл в папке с программой).

#### Настройка ngrok

RusGuard использует HTTPS, однако использует самостоятельно подписанный сертификат. У меня, к сожалению, не было времени
уговаривать Ktor принять такой сертификат, поэтому как обходной путь можно использовать ngrok.

Для этого скачайте на сервер СКУДа программу ngrok и запустите её на сервере СКУД следующей командой:

```shell
ngrok http https://localhost
```

После запуска этой программы, вам будет показан адрес, выданный сервисом. Скопируйте его на локальный компьютер.

## Запуск программы

Откройте папку с программой и запустите файл "run.bat" (если не сработает, откройте файл в блокноте, откройте командную
строку в папке с программой и выполните каждую строку вручную). В консоли появится предложение ввести адрес сервера
RusGuard.
Этот адрес вы должны были скопировать на предыдущем шаге. Добавьте к адресу
приписку `LNetworkServer/LNetworkService.svc`. У вас должен получится адрес
типа `https://0000-000-000-00-00.eu.ngrok.io/LNetworkServer/LNetworkService.svc`. Проверьте адрес и нажмите Enter.

Программа начнёт работу. Она получит список учащихся из заявки на карточки (applications.csv) и сопоставит его с данными
из файла "user-list.xml". В случае, если какие-то учащиеся не найдены, они будут записаны в файл "failed-persons.csv".
Карточки
этих учащихся, к сожалению, придётся создавать вручную.

После сопоставления данных, программа выдаст количество учащихся, которые будут созданы. Если всё верно, нажмите "y" и
Enter. Программа начнёт присваивать карточки учащимся. Если во время работы программы будут ошибки, они будут записаны в
вывод программы, но программа продолжит работу.

## Контакты

Если у вас возникли вопросы, пишите на почту, указанную в профиле на GitHub; постараюсь ответить как можно быстрее.

### Лицензия

Beerware License
